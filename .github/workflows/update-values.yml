name: Chart Version Update Automation

on:
  push:
    branches:
      - main
    paths:
      # Use an explicit list for guaranteed triggering
      - 'app1/values.yaml'
      - 'app2/values.yaml'
      - 'app3/values.yaml'
      - 'app4/values.yaml'
      - 'app5/values.yaml'
      - 'app6/values.yaml'
      - 'app7/values.yaml'

jobs:
  run-chart-update:
    # Use 'local' if you named your runner 'local', or 'self-hosted' if not
    runs-on: local 
    
    # CRITICAL: Explicitly grant write permissions for pushing to both repos
    permissions:
      contents: write
      packages: read 
    
    # Define primary environment variables
    env:
      CHARTMUSEUM_URL: http://192.168.64.2:30080
      REPO_ROOT: ${{ github.workspace }}
      PARENT_APP_FILE: ${{ github.workspace }}/parentapp.yaml

    steps:
      - name: ‚¨áÔ∏è Checkout Source Repository (for template/app folders)
        uses: actions/checkout@v4
        
      - name: ‚¨áÔ∏è Clone ArgoCD Apps Repository
        shell: bash
        run: |
          export ARGOCD_LOCAL="${{ runner.temp }}/argo-apps-clone" # Use ${{ runner.temp }} since it ran successfully
          
          echo "Cloning ArgoCD Apps repo to ${{ env.ARGOCD_LOCAL }}"
          if ! git clone --depth 1 https://github.com/sidhuni/argo-apps.git "${{ env.ARGOCD_LOCAL }}"; then
              echo "‚ùå ERROR: Failed to clone ArgoCD repository."
              exit 1
          fi
          
      - name: üèÉ Run Full Chart Update, Package, and Upload Logic
        shell: bash
        run: |
          set -euo pipefail
          
          export ARGOCD_LOCAL="${{ env.ARGOCD_LOCAL }}"
          
          echo "--- 1. Discovery and Versioning ---"
          
          APPS=($(find . -maxdepth 1 -type d ! -name 'template' ! -name '.' ! -name '.*' -exec basename {} \; | sort -V))
          
          TEMPLATE_CHART="./template/Chart.yaml"
          TEMPLATE_VERSION=$(grep "^version:" "$TEMPLATE_CHART" | awk '{print $2}')
          
          # Use cut for safe integer assignment
          BASE_MAJOR=$(echo "$TEMPLATE_VERSION" | cut -d. -f1)
          BASE_MINOR=$(echo "$TEMPLATE_VERSION" | cut -d. -f2)
          BASE_PATCH=$(echo "$TEMPLATE_VERSION" | cut -d. -f3)

          # --- 2. Loop Through All Apps and Process ---
          for i in "${!APPS[@]}"; do
              APP_NAME="${APPS[$i]}"
              APP_DIR="./$APP_NAME"
              
              PATCH=$((BASE_PATCH + i + 1))
              NEW_VERSION="$BASE_MAJOR.$BASE_MINOR.$PATCH"

              BASE_CHART_NAME=$(grep "^name:" "$TEMPLATE_CHART" | awk '{print $2}')
              APP_NUMBER=$(echo "$APP_NAME" | grep -o '[0-9]\+' || echo "")
              NEW_CHART_NAME="${BASE_CHART_NAME}${APP_NUMBER}"

              echo "---------------------------------------"
              echo "Processing $APP_NAME, Version: $NEW_VERSION, Chart: $NEW_CHART_NAME"

              mkdir -p "$APP_DIR/charts"
              cp "$TEMPLATE_CHART" "$APP_DIR/Chart.yaml"
              
              # Use BSD sed syntax (sed -i '') for Mac runner
              sed -i '' "s/^name:.*/name: $NEW_CHART_NAME/" "$APP_DIR/Chart.yaml"
              sed -i '' "s/^version:.*/version: $NEW_VERSION/" "$APP_DIR/Chart.yaml"

              # Build, Package, and Upload
              if ! cd "$APP_DIR"; then exit 1; fi
              helm dependency update >/dev/null
              PACKAGE_OUTPUT=$(helm package . --destination .)
              PACKAGE_FILE=$(echo "$PACKAGE_OUTPUT" | awk -F': ' '/Successfully packaged chart/ {print $NF}')
              
              echo "Uploading $PACKAGE_FILE..."
              curl --fail --silent --show-error --data-binary "@$PACKAGE_FILE" "${{ env.CHARTMUSEUM_URL }}/api/charts"
              echo " Upload complete."

              if ! cd "${{ env.REPO_ROOT }}"; then exit 1; fi

              # Update ArgoCD App YAML in the CLONED repo
              APP_FILE="$ARGOCD_LOCAL/application/$APP_NAME.yaml"
              if [ ! -f "$APP_FILE" ]; then echo "‚ùå Error: ArgoCD app file not found: $APP_FILE"; exit 1; fi
              
              # Use BSD sed syntax (sed -i '') for Mac runner
              sed -i '' "s/targetRevision:.*/targetRevision: $NEW_VERSION/" "$APP_FILE"
              sed -i '' "s/chart:.*/chart: $NEW_CHART_NAME/" "$APP_FILE"

              # Cleanup local chart files
              rm -rf "$APP_DIR/Chart.yaml" "$APP_DIR/Chart.lock" "$APP_DIR/*.tgz" "$APP_DIR/charts"
              
              echo "‚úÖ $APP_NAME processed successfully."
          done

      - name: ‚¨ÜÔ∏è Commit and Push ArgoCD Changes
        shell: bash
        run: |
          export ARGOCD_LOCAL="${{ env.ARGOCD_LOCAL }}" 
          if ! cd "$ARGOCD_LOCAL"; then exit 1; fi
          
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          if git diff --exit-code application/*.yaml >/dev/null; then
              echo "No changes detected in ArgoCD application YAMLs. Skipping commit."
          else
              echo "Committing changes to ArgoCD repository..."
              git add application/*.yaml
              git commit -m "Automated update: Chart versions synced with values change"
              git push
              echo "Pushed updated ArgoCD manifests."
          fi
          
      # üåü NEW STEP: Commit the changes made to the values.yaml source repo üåü
      - name: ‚¨ÜÔ∏è Commit and Push Changes in Values Repository (Source Repo)
        shell: bash
        run: |
          if ! cd ${{ env.REPO_ROOT }}; then exit 1; fi
          
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # The logic assumes the user's initial push of the values file was already done.
          # This step is here for any subsequent auto-modifications to values files.
          if git diff --exit-code */values.yaml >/dev/null; then
              echo "No uncommitted changes in values.yaml files in source repo."
          else
              echo "Committing changes to the source repository (values.yaml)..."
              git add */values.yaml
              git commit -m "Automated update: Synchronized values.yaml changes."
              git push
              echo "Pushed changes to the source repository."
          fi

      - name: üöÄ Apply Parent Application (Force Sync on Cluster)
        shell: bash
        run: |
          echo "Applying parent application manifest: ${{ env.PARENT_APP_FILE }}..."
          
          if [ -f "${{ env.PARENT_APP_FILE }}" ]; then
              kubectl apply -f "${{ env.PARENT_APP_FILE }}"
              echo "Parent application applied successfully."
          else
              echo "‚ùå ERROR: Parent app file not found at ${{ env.PARENT_APP_FILE }}. Skipping kubectl apply."
              exit 1 
          fi
