name: Chart Version Update Automation

on:
  push:
    branches:
      - main
    paths:
      # FIX: Use single-level wildcard for reliable triggering from the repo root
      - '*/values.yaml'

jobs:
  run-chart-update:
    runs-on: self-hosted
    
    # Define primary fixed environment variables available to all steps
    env:
      CHARTMUSEUM_URL: http://192.168.64.2:30080
      REPO_ROOT: ${{ github.workspace }}
      PARENT_APP_FILE: ${{ github.workspace }}/parentapp.yaml

    steps:
      - name: ‚¨áÔ∏è Checkout Source Repository (for template/app folders)
        uses: actions/checkout@v4
        
      - name: ‚¨áÔ∏è Clone ArgoCD Apps Repository (FIXED PATH)
        shell: bash
        run: |
          # Use $RUNNER_TEMP to create a stable, temporary directory for the clone
          export ARGOCD_LOCAL="$RUNNER_TEMP/argo-apps-clone"
          
          echo "Cloning ArgoCD Apps repo to $ARGOCD_LOCAL"
          # NOTE: Replace the URL with your actual ArgoCD repo clone URL
          git clone --depth 1 https://github.com/sidhuni/argo-apps.git $ARGOCD_LOCAL
          
      - name: üèÉ Run Full Chart Update, Package, and Upload Logic
        shell: bash
        run: |
          set -euo pipefail
          
          # Re-define ARGOCD_LOCAL in the shell for continued use
          export ARGOCD_LOCAL="$RUNNER_TEMP/argo-apps-clone" 
          
          echo "--- 1. Discovery and Versioning ---"
          
          # Find apps, exclude system folders, and sort numerically
          APPS=($(find . -maxdepth 1 -type d ! -name 'template' ! -name '.' ! -name '.*' -exec basename {} \; | sort -V))
          
          TEMPLATE_CHART="./template/Chart.yaml"
          TEMPLATE_VERSION=$(grep "^version:" "$TEMPLATE_CHART" | awk '{print $2}')
          IFS='.' read -r BASE_MAJOR BASE_MINOR BASE_PATCH <<< "$TEMPLATE_VERSION"

          # --- 2. Loop Through All Apps and Process ---
          for i in "${!APPS[@]}"; do
              APP_NAME="${APPS[$i]}"
              APP_DIR="./$APP_NAME"
              
              PATCH=$((BASE_PATCH + i + 1))
              NEW_VERSION="$BASE_MAJOR.$BASE_MINOR.$PATCH"

              BASE_CHART_NAME=$(grep "^name:" "$TEMPLATE_CHART" | awk '{print $2}')
              APP_NUMBER=$(echo "$APP_NAME" | grep -o '[0-9]\+' || echo "")
              NEW_CHART_NAME="${BASE_CHART_NAME}${APP_NUMBER}"

              echo "---------------------------------------"
              echo "Processing $APP_NAME, Version: $NEW_VERSION, Chart: $NEW_CHART_NAME"

              mkdir -p "$APP_DIR/charts"
              cp "$TEMPLATE_CHART" "$APP_DIR/Chart.yaml"
              
              # Use BSD sed syntax (sed -i '') for Mac runner
              sed -i '' "s/^name:.*/name: $NEW_CHART_NAME/" "$APP_DIR/Chart.yaml"
              sed -i '' "s/^version:.*/version: $NEW_VERSION/" "$APP_DIR/Chart.yaml"

              # Build, Package, and Upload
              cd "$APP_DIR"
              helm dependency update >/dev/null
              PACKAGE_OUTPUT=$(helm package . --destination .)
              PACKAGE_FILE=$(echo "$PACKAGE_OUTPUT" | awk -F': ' '/Successfully packaged chart/ {print $NF}')
              
              echo "Uploading $PACKAGE_FILE..."
              curl --fail --silent --show-error --data-binary "@$PACKAGE_FILE" "${{ env.CHARTMUSEUM_URL }}/api/charts"
              echo " Upload complete."

              cd "${{ env.REPO_ROOT }}" # Return to the root of the source repo

              # Update ArgoCD App YAML in the CLONED repo
              APP_FILE="$ARGOCD_LOCAL/application/$APP_NAME.yaml"
              if [ ! -f "$APP_FILE" ]; then
                  echo "‚ùå Error: ArgoCD app file not found: $APP_FILE"
                  exit 1
              fi
              # Use BSD sed syntax (sed -i '') for Mac runner
              sed -i '' "s/targetRevision:.*/targetRevision: $NEW_VERSION/" "$APP_FILE"
              sed -i '' "s/chart:.*/chart: $NEW_CHART_NAME/" "$APP_FILE"

              # Cleanup
              rm -rf "$APP_DIR/Chart.yaml" "$APP_DIR/Chart.lock" "$APP_DIR/*.tgz" "$APP_DIR/charts"
              
              echo "‚úÖ $APP_NAME processed successfully."
          done

      - name: ‚¨ÜÔ∏è Commit and Push ArgoCD Changes
        shell: bash
        run: |
          # Redefine ARGOCD_LOCAL using the shell environment variable $RUNNER_TEMP 
          export ARGOCD_LOCAL="$RUNNER_TEMP/argo-apps-clone" 
          cd "$ARGOCD_LOCAL"
          
          # Configure Git user for the commit
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # Check for changes and commit/push
          if git diff --exit-code application/*.yaml >/dev/null; then
              echo "No changes detected in ArgoCD application YAMLs. Skipping commit."
          else
              echo "Committing changes to ArgoCD repository..."
              git add application/*.yaml
              git commit -m "Automated update: Chart versions synced with values change"
              git push
              echo "Pushed updated ArgoCD manifests."
          fi

      - name: üöÄ Apply Parent Application (Force Sync on Cluster)
        shell: bash
        run: |
          echo "Applying parent application manifest: ${{ env.PARENT_APP_FILE }}..."
          
          if [ -f "${{ env.PARENT_APP_FILE }}" ]; then
              kubectl apply -f "${{ env.PARENT_APP_FILE }}"
              echo "Parent application applied successfully."
          else
              echo "‚ùå ERROR: Parent app file not found at ${{ env.PARENT_APP_FILE }}. Skipping kubectl apply."
              exit 1 
          fi
