name: Chart Version Update Automation (Full Script Replacement)

on:
  push:
    branches:
      - main
    paths:
      # Use an explicit list for guaranteed triggering
      - 'app1/values.yaml'
      - 'app2/values.yaml'
      - 'app3/values.yaml'
      - 'app4/values.yaml'
      - 'app5/values.yaml'
      - 'app6/values.yaml'
      - 'app7/values.yaml'

jobs:
  run-chart-update:
    # Use the specific name you assigned to your runner
    runs-on: local 
    
    # CRITICAL: Explicitly grant write permissions
    permissions:
      contents: write
      packages: read 
    
    # Define simple, non-conflicting environment variables
    env:
      CHARTMUSEUM_URL: http://192.168.64.2:30080
      REPO_ROOT: ${{ github.workspace }}
      # PARENT_APP_FILE definition will use ARGOCD_LOCAL in the 'run' step

    steps:
      - name: ‚¨áÔ∏è Checkout Source Repository
        uses: actions/checkout@v4
        
      - name: ‚¨áÔ∏è Clone ArgoCD Apps Repository
        shell: bash
        run: |
          # üåü FIX: Define ARGOCD_LOCAL using the shell variable $RUNNER_TEMP üåü
          export ARGOCD_LOCAL="$RUNNER_TEMP/argo-apps-clone"
          
          echo "Cloning ArgoCD Apps repo to $ARGOCD_LOCAL"
          if ! git clone --depth 1 https://github.com/sidhuni/argo-apps.git "$ARGOCD_LOCAL"; then
              echo "‚ùå ERROR: Failed to clone ArgoCD repository."
              exit 1
          fi
          
      - name: üèÉ Run Full Automation Logic (Build, Upload, Update ArgoCD)
        shell: bash
        run: |
          set -euo pipefail
          
          # Define necessary runtime variables inside the shell
          export ARGOCD_LOCAL="$RUNNER_TEMP/argo-apps-clone"
          export REPO_ROOT="${{ env.REPO_ROOT }}"
          
          echo "--- 1. Discovery and Versioning ---"
          
          APPS=($(find . -maxdepth 1 -type d ! -name 'template' ! -name '.' ! -name '.*' -exec basename {} \; | sort -V))
          
          TEMPLATE_CHART="./template/Chart.yaml"
          TEMPLATE_VERSION=$(grep "^version:" "$TEMPLATE_CHART" | awk '{print $2}')
          
          BASE_MAJOR=$(echo "$TEMPLATE_VERSION" | cut -d. -f1)
          BASE_MINOR=$(echo "$TEMPLATE_VERSION" | cut -d. -f2)
          BASE_PATCH=$(echo "$TEMPLATE_VERSION" | cut -d. -f3)

          # --- 2. Loop Through All Apps and Process ---
          for i in "${!APPS[@]}"; do
              APP_NAME="${APPS[$i]}"
              APP_DIR="./$APP_NAME"
              
              PATCH=$((BASE_PATCH + i + 1))
              NEW_VERSION="$BASE_MAJOR.$BASE_MINOR.$PATCH"

              BASE_CHART_NAME=$(grep "^name:" "$TEMPLATE_CHART" | awk '{print $2}')
              APP_NUMBER=$(echo "$APP_NAME" | grep -o '[0-9]\+' || echo "")
              NEW_CHART_NAME="${BASE_CHART_NAME}${APP_NUMBER}"

              echo "--- Processing $APP_NAME: Version $NEW_VERSION ---"

              # Prepare folder and update Chart.yaml
              mkdir -p "$APP_DIR/charts"
              cp "$TEMPLATE_CHART" "$APP_DIR/Chart.yaml"
              sed -i '' "s/^name:.*/name: $NEW_CHART_NAME/" "$APP_DIR/Chart.yaml"
              sed -i '' "s/^version:.*/version: $NEW_VERSION/" "$APP_DIR/Chart.yaml"

              # Build, Package, and Upload
              if ! cd "$APP_DIR"; then exit 1; fi
              helm dependency update >/dev/null
              PACKAGE_OUTPUT=$(helm package . --destination .)
              PACKAGE_FILE=$(echo "$PACKAGE_OUTPUT" | awk -F': ' '/Successfully packaged chart/ {print $NF}')
              
              echo "Uploading $PACKAGE_FILE..."
              curl --fail --silent --show-error --data-binary "@$PACKAGE_FILE" "${{ env.CHARTMUSEUM_URL }}/api/charts"
              echo -e "\nUpload complete."

              if ! cd "$REPO_ROOT"; then exit 1; fi

              # Update ArgoCD App YAML in the CLONED repo
              APP_FILE="$ARGOCD_LOCAL/application/$APP_NAME.yaml"
              if [ ! -f "$APP_FILE" ]; then echo "‚ùå ArgoCD app file not found: $APP_FILE"; exit 1; fi
              sed -i '' "s/targetRevision:.*/targetRevision: $NEW_VERSION/" "$APP_FILE"
              sed -i '' "s/chart:.*/chart: $NEW_CHART_NAME/" "$APP_FILE"

              # Cleanup local chart files
              rm -rf "$APP_DIR/Chart.yaml" "$APP_DIR/Chart.lock" "$PACKAGE_FILE"¬†
              rm -rf "$APP_DIR/charts"
              
              echo "‚úÖ $APP_NAME processed successfully."
          done

      - name: ‚¨ÜÔ∏è Commit and Push ArgoCD Changes
        shell: bash
        run: |
          export ARGOCD_LOCAL="$RUNNER_TEMP/argo-apps-clone" 
          if ! cd "$ARGOCD_LOCAL"; then exit 1; fi
          
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          if git diff --exit-code application/*.yaml >/dev/null; then
              echo "No changes detected in ArgoCD application YAMLs. Skipping commit."
          else
              echo "Committing changes to ArgoCD repository..."
              git add application/*.yaml
              git commit -m "Automated update: Chart versions synced"
              git push
              echo "Pushed updated ArgoCD manifests."
          fi

      - name: ‚¨ÜÔ∏è Commit and Push Changes in Values Repository (Source Repo)
        shell: bash
        run: |
          if ! cd ${{ env.REPO_ROOT }}; then exit 1; fi
          
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          if git diff --exit-code */values.yaml >/dev/null; then
              echo "No uncommitted changes in values.yaml files in source repo."
          else
              echo "Committing changes to the source repository (values.yaml)..."
              git add */values.yaml
              git commit -m "Automated update: Synchronized values.yaml changes."
              git push
              echo "Pushed changes to the source repository."
          fi

      - name: üöÄ Apply Parent Application (Force Sync on Cluster)
        shell: bash
        run: |
          # Define the parent app file path using the temporary location
          PARENT_APP_FILE="$RUNNER_TEMP/argo-apps-clone/parentapp.yaml"
          echo "Applying parent application manifest: $PARENT_APP_FILE..."
          
          if [ -f "$PARENT_APP_FILE" ]; then
              kubectl apply -f "$PARENT_APP_FILE"
              echo "Parent application applied successfully."
          else
              echo "‚ùå ERROR: Parent app file not found at $PARENT_APP_FILE. Skipping kubectl apply."
              exit 1 
          fi